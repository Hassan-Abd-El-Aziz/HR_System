{% extends "base.html" %} {% block title %}تسجيل الحضور - نظام الموارد البشرية{%
endblock %} {% block content %}
<div class="page-header">
  <h1><i class="fas fa-calendar-plus"></i> تسجيل الحضور والانصراف</h1>
  <a href="{{ url_for('attendance') }}" class="btn btn-secondary">
    <i class="fas fa-arrow-right"></i> العودة للحضور
  </a>
</div>

<div class="attendance-container">
  <div class="attendance-section">
    <h3><i class="fas fa-users"></i> تسجيل الحضور الفردي</h3>

    <div class="form-container">
      <form id="attendanceForm">
        <div class="form-group">
          <label for="employeeSelect">اختر الموظف:</label>
          <select id="employeeSelect" class="form-control" required>
            <option value="">اختر الموظف</option>
            {% for employee in employees %}
            <option value="{{ employee.id }}">
              {{ employee.first_name }} {{ employee.last_name }} - {{
              employee.position }} ({{ employee.department_name }})
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="action-buttons">
          <button
            type="button"
            onclick="markAttendance('check_in')"
            class="btn btn-success btn-lg"
          >
            <i class="fas fa-sign-in-alt"></i> تسجيل الحضور
          </button>
          <button
            type="button"
            onclick="markAttendance('check_out')"
            class="btn btn-warning btn-lg"
          >
            <i class="fas fa-sign-out-alt"></i> تسجيل الانصراف
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="attendance-section">
    <h3>
      <i class="fas fa-clock"></i> الحضور المسجل لليوم ({{
      today.strftime('%Y-%m-%d') }})
    </h3>

    {% if today_attendance %}
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>الموظف</th>
            <th>الحضور</th>
            <th>الانصراف</th>
            <th>الحالة</th>
          </tr>
        </thead>
        <tbody>
          {% for record in today_attendance %}
          <tr>
            <td>
              <strong>{{ record.first_name }} {{ record.last_name }}</strong>
              <br /><small>{{ record.position }}</small>
            </td>
            <td>
              {% if record.check_in %}
              <span class="time-badge"
                >{{ record.check_in.strftime('%H:%M') }}</span
              >
              {% else %}
              <span class="badge badge-secondary">لم يحضر</span>
              {% endif %}
            </td>
            <td>
              {% if record.check_out %}
              <span class="time-badge"
                >{{ record.check_out.strftime('%H:%M') }}</span
              >
              {% else %}
              <span class="badge badge-warning">لم ينصرف</span>
              {% endif %}
            </td>
            <td>
              <span class="status-badge status-{{ record.status }}">
                {{ 'حاضر' if record.status == 'present' else 'متأخر' if
                record.status == 'late' else record.status }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      <i class="fas fa-clock fa-3x"></i>
      <h4>لا توجد سجلات حضور لليوم</h4>
      <p>لم يتم تسجيل أي حضور حتى الآن.</p>
    </div>
    {% endif %}
  </div>
</div>

<style>
  .attendance-container {
    display: grid;
    gap: 2rem;
  }

  .attendance-section {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .attendance-section h3 {
    color: #2c3e50;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border-bottom: 2px solid #ecf0f1;
    padding-bottom: 0.5rem;
  }

  .form-container {
    max-width: 500px;
    margin: 0 auto;
  }

  .action-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    justify-content: center;
  }

  .btn-success {
    background: #27ae60;
    color: white;
    border: none;
    padding: 1rem 2rem;
    font-size: 1.1rem;
  }

  .btn-warning {
    background: #f39c12;
    color: white;
    border: none;
    padding: 1rem 2rem;
    font-size: 1.1rem;
  }

  .btn-success:hover {
    background: #219653;
    transform: translateY(-2px);
  }

  .btn-warning:hover {
    background: #e67e22;
    transform: translateY(-2px);
  }

  .form-control {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #ecf0f1;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s;
  }

  .form-control:focus {
    outline: none;
    border-color: #3498db;
  }
</style>

<script>
  function markAttendance(action) {
    const employeeSelect = document.getElementById("employeeSelect");
    const employeeId = employeeSelect.value;

    if (!employeeId) {
      alert("يرجى اختيار موظف");
      return;
    }

    const actionText = action === "check_in" ? "الحضور" : "الانصراف";

    if (confirm(`هل تريد تسجيل ${actionText} لهذا الموظف؟`)) {
      fetch("/mark_attendance", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          employee_id: parseInt(employeeId),
          action: action,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            alert(data.message);
            // إعادة تحميل الصفحة لعرض التحديثات
            setTimeout(() => {
              location.reload();
            }, 1000);
          } else {
            alert("خطأ: " + data.message);
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("حدث خطأ أثناء تسجيل الحضور");
        });
    }
  }

  // تحديث تلقائي كل 30 ثانية
  setTimeout(() => {
    location.reload();
  }, 30000);
</script>
{% endblock %}

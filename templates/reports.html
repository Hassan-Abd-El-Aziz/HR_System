{% extends "base.html" %} {% block title %}التقارير - نظام الموارد البشرية{%
endblock %} {% block content %}
<div class="page-header">
  <h1>التقارير والإحصائيات</h1>
  <div class="header-actions">
    <button class="btn btn-primary" onclick="exportToExcel()">
      <i class="fas fa-file-excel"></i> تصدير إلى Excel
    </button>
    <button class="btn btn-secondary" onclick="printReports()">
      <i class="fas fa-print"></i> طباعة
    </button>
  </div>
</div>

<div class="reports-grid">
  <div class="report-card">
    <div class="card-header">
      <h3><i class="fas fa-chart-pie"></i> توزيع الموظفين حسب الأقسام</h3>
    </div>
    <div class="chart-container">
      <canvas id="departmentChart"></canvas>
    </div>
    <div class="chart-summary" id="departmentSummary"></div>
  </div>
  <div class="report-card">
    <div class="card-header">
      <h3><i class="fas fa-users"></i> ملخص الموظفين</h3>
    </div>
    <div class="summary-stats">
      <div class="stat-item">
        <div class="stat-icon total-employees">
          <i class="fas fa-user-friends"></i>
        </div>
        <div class="stat-info">
          <h4 id="totalEmployees">{{ total_employees }}</h4>
          <p>إجمالي الموظفين</p>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-icon active-employees">
          <i class="fas fa-user-check"></i>
        </div>
        <div class="stat-info">
          <h4 id="activeEmployees">{{ active_employees }}</h4>
          <p>موظفين نشطين</p>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-icon average-salary">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-info">
          <h3>{{ attendance_rate }}%</h3>
          <p>معدل التواجد</p>
          <small>نسبة الموظفين النشطين</small>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-icon departments-count">
          <i class="fas fa-building"></i>
        </div>
        <div class="stat-info">
          <h4 id="departmentsCount">{{ total_departments }}</h4>
          <p>عدد الأقسام</p>
        </div>
      </div>
    </div>
  </div>

  <!-- <div class="report-card">
    <div class="card-header">
      <h3><i class="fas fa-chart-bar"></i> توزيع الرواتب</h3>
    </div>
    <div class="chart-container">
      <canvas id="salaryChart"></canvas>
    </div>
    <div class="chart-summary" id="salarySummary"></div>
  </div> -->

  <div class="report-card full-width">
    <div class="card-header">
      <h3><i class="fas fa-table"></i> إحصائيات مفصلة</h3>
      <div class="card-actions">
        <button class="btn btn-sm btn-secondary" onclick="exportTableToCSV()">
          <i class="fas fa-download"></i> CSV
        </button>
      </div>
    </div>
    <div class="reports-controls">
      <div class="filters">
        <select id="departmentFilter" class="filter-select">
          <option value="">جميع الأقسام</option>
          {% for dept in departments %}
          <option id="dep-val" value="{{ dept.id }}">{{ dept.name }}</option>
          {% endfor %}
        </select>

        <select id="statusFilter" class="filter-select">
          <option value="">جميع الحالات</option>
          <option value="active">نشط</option>
          <option value="inactive">غير نشط</option>
        </select>

        <input
          type="text"
          id="searchInput"
          placeholder="بحث في الموظفين..."
          class="search-input"
        />
      </div>
    </div>
    <div class="table-container">
      <table class="data-table" id="data-table">
        <thead>
          <tr>
            <th>صورة الموظف</th>
            <th>رقم الموظف</th>
            <th>الاسم</th>
            <th>البريد الإلكتروني</th>
            <th>القسم</th>
            <th>الوظيفة</th>
            <th>الراتب</th>
            <th>الحالة</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for employee in employees %}
          <tr
            data-department="{{ employee.department_id }}"
            data-status="{{ employee.status }}"
          >
            <td>
              <div class="employee-avatar">
                {% if employee.profile_picture_url %}
                <img
                  src="{{ url_for('uploaded_file', filename=employee.profile_picture_url) }}"
                  alt="{{ employee.first_name }} {{ employee.last_name }}"
                  class="employee-thumbnail"
                />
                {% else %}
                <i class="fas fa-user-circle"></i>
                {% endif %}
              </div>
            </td>
            <td>{{ employee.employee_id }}</td>
            <td>{{ employee.first_name }} {{ employee.last_name }}</td>
            <td>{{ employee.email }}</td>
            <td>{{ employee.department_name }}</td>
            <td>{{ employee.position }}</td>
            <td>{{ "{:,.2f}".format(employee.salary) }} ر.س</td>
            <td>
              <span class="status-badge status-{{ employee.status }}">
                {% if employee.status == 'active' %}نشط{% else %}غير نشط{% endif
                %}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <a
                  href="{{ url_for('edit_employee', employee_id=employee.id) }}"
                  class="btn btn-sm btn-edit"
                  title="تعديل"
                >
                  <i class="fas fa-edit"></i>
                </a>
                <a
                  href="{{ url_for('delete_employee', employee_id=employee.id) }}"
                  class="btn btn-sm btn-delete"
                  onclick="return confirm('هل أنت متأكد من حذف الموظف {{ employee.first_name }} {{ employee.last_name }}؟')"
                  title="حذف"
                >
                  <i class="fas fa-trash"></i>
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- بطاقات إضافية -->

  <!-- <div class="report-card">
    <div class="card-header">
      <h3><i class="fas fa-chart-line"></i> اتجاهات التوظيف</h3>
    </div>
    <div class="chart-container">
      <canvas id="hiringTrendChart"></canvas>
    </div>
  </div> -->
</div>

<!-- ستايلات إضافية -->
<style>
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .header-actions {
    display: flex;
    gap: 1rem;
  }

  .reports-controls {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }

  .filters {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-width: 200px;
  }

  .filter-group label {
    font-weight: 500;
    color: #2c3e50;
  }

  .filter-group select {
    padding: 0.75rem;
    border: 1px solid #bdc3c7;
    border-radius: 5px;
    background: white;
  }

  .reports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
  }

  .report-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
  }

  .report-card.full-width {
    grid-column: 1 / -1;
  }

  .search-input {
    flex: 1;
    min-width: 200px;
  }
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #ecf0f1;
    padding-bottom: 1rem;
  }

  .card-header h3 {
    margin: 0;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .chart-container {
    position: relative;
    height: 300px;
    width: 100%;
  }

  .chart-summary {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 5px;
    font-size: 0.9rem;
    color: #495057;
  }

  .employee-thumbnail {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #3498db;
  }
  /* الجداول */
  .table-container {
    background: white;
    border-radius: 10px;
    overflow-x: scroll;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
  }

  .data-table th,
  .data-table td {
    padding: 1rem;
    text-align: center;
    border-bottom: 1px solid #ecf0f1;
  }

  .data-table th {
    background: #34495e;
    color: white;
    font-weight: 600;
  }

  .data-table tr:hover {
    background: #f8f9fa;
  }

  .total-row td {
    border-top: 2px solid #dee2e6;
  }

  .summary-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .stat-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
  }

  .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
  }

  .total-employees {
    background: #3498db;
  }
  .active-employees {
    background: #2ecc71;
  }
  .average-salary {
    background: #9b59b6;
  }
  .departments-count {
    background: #e67e22;
  }

  .stat-info h4 {
    margin: 0;
    font-size: 1.5rem;
    color: #2c3e50;
  }

  .stat-info p {
    margin: 0.25rem 0 0 0;
    color: #7f8c8d;
    font-size: 0.9rem;
  }

  /* استجابة للشاشات الصغيرة */
  @media (max-width: 768px) {
    .reports-grid {
      grid-template-columns: 1fr;
    }

    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .summary-stats {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- مكتبة Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // تعريف المتغيرات للرسوم البيانية
  let departmentChartInstance = null;
  let salaryChartInstance = null;
  let hiringTrendChartInstance = null;

  // ألوان للرسوم البيانية
  const chartColors = [
    "#3498db",
    "#2ecc71",
    "#e74c3c",
    "#f39c12",
    "#9b59b6",
    "#1abc9c",
    "#d35400",
    "#c0392b",
    "#16a085",
    "#8e44ad",
  ];

  // تحميل البيانات عند فتح الصفحة
  document.addEventListener("DOMContentLoaded", function () {
    loadAllCharts();
    updateSummaryStats();
  });

  // تحميل جميع الرسوم البيانية
  async function loadAllCharts() {
    await loadDepartmentChart();
  }

  // رسم بياني لتوزيع الموظفين حسب الأقسام
  async function loadDepartmentChart() {
    try {
      const response = await fetch("/api/reports/department-distribution");
      const data = await response.json();

      const ctx = document.getElementById("departmentChart").getContext("2d");

      // تدمير المخطط السابق إذا كان موجوداً
      if (departmentChartInstance) {
        departmentChartInstance.destroy();
      }

      departmentChartInstance = new Chart(ctx, {
        type: "pie",
        data: {
          labels: data.labels,
          datasets: [
            {
              data: data.data,
              backgroundColor: chartColors,
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "left",
              rtl: true,
            },
            tooltip: {
              rtl: true,
              callbacks: {
                label: function (context) {
                  let label = context.label || "";
                  if (label) {
                    label += ": ";
                  }
                  label += context.raw + " موظف";
                  return label;
                },
              },
            },
          },
        },
      });

      // تحديث الملخص
      const total = data.data.reduce((a, b) => a + b, 0);
      document.getElementById("departmentSummary").innerHTML = `
        <strong>إجمالي الموظفين:</strong> ${total} موظف<br>
        <strong>عدد الأقسام:</strong> ${data.labels.length} قسم
      `;
    } catch (error) {
      console.error("Error loading department chart:", error);
    }
  }

  // فلترة التقارير
  function filterReports() {
    const department = document.getElementById("departmentFilter").value;
    const period = document.getElementById("dateFilter").value;
    const tableRows = document.querySelectorAll(".data-table tbody tr");

    tableRows.forEach((row) => {
      const department = row.getAttribute("data-department");
      const status = row.getAttribute("data-status");
      const rowText = row.textContent.toLowerCase();

      const departmentMatch =
        !departmentValue || department === departmentValue;
      const statusMatch = !statusValue || status === statusValue;
      const searchMatch = !searchValue || rowText.includes(searchValue);

      if (departmentMatch && statusMatch && searchMatch) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
    // هنا يمكنك إضافة منطق الفلترة
    // يمكنك إعادة تحميل البيانات مع معلمات الفلترة
    console.log("Filtering by:", { department, period });

    // إعادة تحميل الرسوم البيانية مع الفلترة
    loadAllCharts();
  }

  // تصدير إلى Excel
  function exportToExcel() {
    window.location.href = "/export/reports/excel";
  }

  // طباعة التقارير
  function printReports() {
    window.print();
  }

  // تصدير الجدول إلى CSV
  function exportTableToCSV() {
    const table = document.getElementById("data-table");
    const rows = table.querySelectorAll("tr");
    const csv = [];

    rows.forEach((row) => {
      const rowData = [];
      const cells = row.querySelectorAll("th, td");

      cells.forEach((cell) => {
        // إزالة أي فواصل من النص لتجنب مشاكل CSV
        let text = cell.textContent.replace(/,/g, ";").trim();
        rowData.push(text);
      });

      csv.push(rowData.join(","));
    });

    const csvContent = csv.join("\n");
    const blob = new Blob(["\uFEFF" + csvContent], {
      type: "text/csv;charset=utf-8;",
    });
    const link = document.createElement("a");

    link.href = URL.createObjectURL(blob);
    link.download = `reports_${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
  }

  // إضافة API endpoint إضافي في حالة عدم وجوده
  // يمكنك إضافته في Flask route
  /*
  @app.route('/api/reports/summary')
  def reports_summary():
      total_employees = db.session.query(func.count(Employee.id)).scalar() or 0
      active_employees = db.session.query(func.count(Employee.id)).filter(
          Employee.status == 'active'
      ).scalar() or 0
      average_salary = db.session.query(func.avg(Employee.salary)).scalar() or 0
      departments_count = db.session.query(func.count(Department.id)).scalar() or 0

      return jsonify({
          'total_employees': total_employees,
          'active_employees': active_employees,
          'average_salary': float(average_salary),
          'departments_count': departments_count
      })
  */
</script>
{% endblock %}
